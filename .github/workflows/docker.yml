# This workflow tests Docker container build and startup

name: Docker CI
permissions:
  contents: read

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Create test .env file
        run: |
          cat > .env << 'EOF'
          ALLOW_LIST=0x0000000000000000000000000000000000000001
          XMTP_ENV=dev
          XOMBI_SIGNER_KEY=0xfea670adb161532db7fae1ba25519b1a8848c2517c5c1c78261a633c7b1c9641
          XMTP_ENCRYPTION_KEY=0x2b48c8ed182277360a6e6ed62d6adb58efc344835ea97772546a027ac7d2a42e
          OMBI_API_KEY=test-api-key
          OMBI_API_URL=http://localhost:5000
          USERNAME_0x0000000000000000000000000000000000000001=testuser@example.com
          OMBI_XOMBI_WEBHOOK_ENABLED=false
          XMTP_REVOKE_ALL_OTHER_INSTALLATIONS=true
          EOF

      - name: Build Docker image
        run: docker build -t xombi:test .

      - name: Start Docker container
        run: |
          # Start container in detached mode with a timeout
          docker run -d --name xombi-test \
            --env-file .env \
            xombi:test

          # Wait for container to start (max 30 seconds)
          echo "Waiting for container to start..."
          for i in {1..30}; do
            if docker ps | grep -q xombi-test; then
              echo "Container started successfully"
              break
            fi
            sleep 1
          done

          # Give the app time to initialize and show any startup errors
          sleep 10

          # Check if container is still running
          if ! docker ps | grep -q xombi-test; then
            echo "‚ùå Container failed to stay running"
            echo "Container logs:"
            docker logs xombi-test
            exit 1
          fi

          # Check logs for successful initialization or errors
          echo "üìã Container logs:"
          docker logs xombi-test

          # Verify the application actually started (not just the container)
          if docker logs xombi-test 2>&1 | grep -q "ERR_MODULE_NOT_FOUND\|Error:"; then
            echo "‚ùå Application failed to start - errors detected in logs"
            exit 1
          fi

          if ! docker logs xombi-test 2>&1 | grep -q "Xombi is running\|XMTP client created\|Listening for"; then
            echo "‚ö†Ô∏è  Warning: Could not confirm application initialization"
            echo "Container is running but application may not have started correctly"
            exit 1
          fi

          echo "‚úÖ Container and application are running successfully"

      - name: Cleanup
        if: always()
        run: |
          docker stop xombi-test || true
          docker rm xombi-test || true
