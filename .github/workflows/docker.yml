# This workflow tests Docker container build and startup

name: Docker CI
permissions:
  contents: read

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  docker:
    strategy:
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
            runner: ubuntu-latest
            tag: xombi:test-amd64
            container_name: xombi-test-amd64
            use_buildx: false
            run_platform: ""
          - arch: arm64
            platform: linux/arm64
            runner: ubuntu-24.04-arm
            tag: xombi:test-arm64
            container_name: xombi-test-arm64
            use_buildx: false
            run_platform: ""
          - arch: amd64-on-arm
            platform: linux/amd64
            runner: ubuntu-24.04-arm
            tag: xombi:test-amd64-on-arm
            container_name: xombi-test-amd64-on-arm
            use_buildx: true
            run_platform: "--platform=linux/amd64"
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v3

      - name: Set up QEMU for cross-arch
        if: ${{ matrix.use_buildx == 'true' }}
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: ${{ matrix.use_buildx == 'true' }}
        uses: docker/setup-buildx-action@v3

      - name: Create test .env file
        run: |
          cat > .env << 'EOF'
          ALLOW_LIST=0x0000000000000000000000000000000000000001
          XMTP_ENV=dev
          XOMBI_SIGNER_KEY=0xfea670adb161532db7fae1ba25519b1a8848c2517c5c1c78261a633c7b1c9641
          XMTP_ENCRYPTION_KEY=0x2b48c8ed182277360a6e6ed62d6adb58efc344835ea97772546a027ac7d2a42e
          OMBI_API_KEY=test-api-key
          OMBI_API_URL=http://localhost:5000
          USERNAME_0x0000000000000000000000000000000000000001=testuser@example.com
          OMBI_XOMBI_WEBHOOK_ENABLED=false
          XMTP_REVOKE_ALL_OTHER_INSTALLATIONS=true
          EOF

      - name: Build image
        run: |
          if [ "${{ matrix.use_buildx }}" = "true" ]; then
            docker buildx build --platform ${{ matrix.platform }} -t ${{ matrix.tag }} --load .
          else
            docker build -t ${{ matrix.tag }} .
          fi

      - name: Start Docker container
        run: |
          docker run -d --name ${{ matrix.container_name }} \
            --env-file .env \
            ${{ matrix.run_platform }} \
            ${{ matrix.tag }}

          echo "Waiting for container to start..."
          for i in {1..30}; do
            if docker ps | grep -q ${{ matrix.container_name }}; then
              echo "Container started successfully"
              break
            fi
            sleep 1
          done

          sleep 10

          if ! docker ps | grep -q ${{ matrix.container_name }}; then
            echo "‚ùå Container failed to stay running"
            echo "Container logs:"
            docker logs ${{ matrix.container_name }}
            exit 1
          fi

          echo "üìã Container logs (${{ matrix.arch }}):"
          docker logs ${{ matrix.container_name }}

          if ! docker logs ${{ matrix.container_name }} 2>&1 | grep -q "Agent initialized on 0x936EccC64dB246f93D172Fd1acA534Ca7153C877"; then
            echo "‚ö†Ô∏è  Warning: Could not confirm application initialization on ${{ matrix.arch }}"
            exit 1
          fi

          echo "‚úÖ ${{ matrix.arch }} container and application are running successfully"

      - name: Cleanup
        if: always()
        run: |
          docker stop ${{ matrix.container_name }} || true
          docker rm ${{ matrix.container_name }} || true
